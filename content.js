if(window.SA&&window.SA._seaart_content_loaded);else{window.SA=window.SA||{},window.SA._seaart_content_loaded=!0;const{SEL:e,$:t,$all:r,applyRegexPipeline:o,applyTitleRegex:n,parseSeaArtDate:i,toYYYYMMDD:a,buildFilename:c,openPopoverAndWait:l,resolveBaseModel:s}=window.SA.utils,{buildXmpXml_XnViewCompat:m,insertXmpIntoWebP:d}=window.SA.xmp;async function getText(e){return(e?.textContent||"").trim()}function pickMetaPopover(){const t=document.querySelectorAll(e.metaPopover);for(const r of t)if(r.querySelector(e.modelsWrap)||r.querySelector(e.advCfgWrap)||r.querySelector(".image-meta")||findPromptContent(r))return r;return document.querySelector(".el-popover.el-popper")||null}function findPromptContent(e){if(!e)return null;const t=(e.querySelector(".image-meta")||e).querySelectorAll(".image-meta-item");for(const e of t){const t=e.querySelector(".image-meta-item-title"),r=e.querySelector(".image-meta-item-content"),o=(t?.textContent||"").trim().toLowerCase();if(r&&o.includes("prompt"))return r}return e.querySelector(".image-meta-item-content")||null}function fetchTextViaBG(e){return new Promise(((t,r)=>{chrome.runtime.sendMessage({type:"SA_FETCH_TEXT",url:e},(e=>chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):e?.ok?void t(e.text):r(new Error(e?.error||"BG text fetch failed"))))}))}function fetchABViaBG(e){return new Promise(((t,r)=>{chrome.runtime.sendMessage({type:"SA_FETCH_AB",url:e},(e=>chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):e?.ok?void t({dataUrl:e.dataUrl,mime:e.mime||""}):r(new Error(e?.error||"BG ab fetch failed"))))}))}function hasXmpChunk(e){try{const t=new Uint8Array(e);for(let e=0;e+4<=t.length;e++)if(88===t[e]&&77===t[e+1]&&80===t[e+2]&&32===t[e+3])return!0}catch(e){}return!1}async function scrapeOnPage(){const c=t(e.fullImg)||document.querySelector("div.image-container img");if(!c)throw new Error("Full image <img> not found.");const m=c.getAttribute("src");if(!m)throw new Error("Image URL not found.");const d=t(e.userLink),u=(d?.textContent||"").trim(),p=(d?.getAttribute("href")||"").split("/user/")[1]||"";try{await l("#app .imgpage-info .el-popover__reference",e.metaPopover,1500)}catch(e){}const f=pickMetaPopover(),w=await getText(findPromptContent(f)),g=o(w);let h="";const y=[],S=r(`${e.modelItem}`,f);for(const t of S){const r=(t.querySelector(e.modelType)?.textContent||"").trim().toLowerCase(),o=(t.querySelector(e.modelName)?.textContent||"").trim();r&&o&&(r.includes("checkpoint")&&!h&&(h=o),r.includes("lora")&&y.push(o))}const b={seed:["Seed","シード","随机种子","랜덤 시드"],steps:["Steps","ステップ","步骤","단계"],sampler:["Sampler","Sampling Method","サンプリング法","采样方法","샘플링 방법"],cfg:["CFG","CFG Scale","CFGスケール","文本强度"],vae:["VAE"],clipskip:["Clip Skip","Clip skip","クリップスキップ"]},A=e=>String(e||"").normalize?.("NFKC").toLowerCase().replace(/[^\p{Letter}\p{Number}]+/gu,""),C=Object.create(null);for(const[e,t]of Object.entries(b))for(const r of t)C[A(r)]=e;const k=Object.create(null);r(e.advCfgRow,f).forEach((t=>{const r=(t.querySelector(e.advKey)?.textContent||"").trim(),o=(t.querySelector(e.advVal)?.textContent||"").trim();let n=C[A(r)],i=o;if(!n&&!o){const e=(t.textContent||"").trim().split(/[:：]/);e.length>=2&&(n=C[A(e[0])],i=e.slice(1).join(":").trim())}n&&""!==i&&(k[n]=i)}));const D=k.seed||"",M=k.sampler||"",_=k.steps||"",E=k.cfg||"",v=k.vae||"",U=k.clipskip||"",$=(t(e.createdDate)?.textContent||"").trim(),x=$?i($):"",L=a(new Date);let O=s(h);const B=(t(e.title)?.textContent||"").trim();return{title:n(B),imgUrl:m,username:u,uid:p,prompt:g,checkpoint:h,loras:y,sampler:M,steps:_,cfgScale:E,vae:v,clipSkip:U,seed:D,createdYMD:x,fileCreatedYMD:L,baseModel:O}}function buildDescription(e){const t=e.loras.map((e=>'"'+e+'"')).join(", ");return`"prompt": "${e.prompt}", "model": "${e.baseModel}", "checkpoint": "${e.checkpoint}", "lora": [${t}], "sampler": "${e.sampler}", "steps": "${e.steps}", "cfg scale": "${e.cfgScale}", "seed": "${e.seed}", "work created": "${e.createdYMD}"`}function buildDescriptionForWindows(e,t,r){const o=e.loras.map((e=>'"'+e+'"')).join(", ");return`"title": "${e.title}", "author": "${t}", "model": "${e.baseModel}", "checkpoint": "${e.checkpoint}", "lora": [${o}], "work created": "${e.createdYMD}", "source": "${r}"`}async function fetchImageArrayBuffer(e){try{const t=await fetch(e,{credentials:"include",mode:"cors"});if(!t.ok)throw new Error("Image fetch failed: "+t.status);return{buffer:await t.arrayBuffer(),mime:t.headers.get("content-type")||""}}catch(t){const r=await fetchABViaBG(e),o=r.dataUrl||"",n=r.mime||"";if(!o)throw new Error("BG fetch failed: "+(r.error||"no data"));const i=o.indexOf(","),a=o.slice(i+1),c=atob(a),l=c.length,s=new Uint8Array(l);for(let e=0;e<l;e++)s[e]=c.charCodeAt(e);return{buffer:s.buffer,mime:n}}}async function runDownload(){if(!window.SA._seaart_running){window.SA._seaart_running=!0;try{const e=await scrapeOnPage(),t=new URL(location.href).href,r=buildDescription(e),o=[e.username,e.uid&&`(${e.uid})`].filter(Boolean).join(" "),n=buildDescriptionForWindows(e,o,t),i=["ai-generated","prompt"],a=(new Date).toISOString(),l=e.createdISO?e.createdISO:e.createdYMD?`${e.createdYMD}T00:00:00Z`:a,s=e.title||"",u=m({creator:o,description:r,keywords:i,sourceUrl:t,title:s,createDateISO:l,modifyDateISO:a}),{buffer:p,mime:f}=await fetchImageArrayBuffer(e.imgUrl),w=f||(e.imgUrl.endsWith(".png")?"image/png":e.imgUrl.endsWith(".jpg")||e.imgUrl.endsWith(".jpeg")?"image/jpeg":"image/webp");let g=p,h=(e.imgUrl.split("?")[0].split(".").pop()||"webp").toLowerCase();if("image/webp"===w){let e=p;if(ArrayBuffer.isView(e)?e=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):e&&e.buffer&&(e=e.buffer),!(e instanceof ArrayBuffer))throw new TypeError("Invalid image buffer for XMP insertion");hasXmpChunk(e);g=d(e,u,n);hasXmpChunk(g)}const y=e.baseModel&&e.baseModel.trim()?e.baseModel:"",S=c({username:e.username,createdYMD:e.createdYMD,baseModel:y,checkpoint:e.checkpoint||"unknown",seed:e.seed||"",fileCreatedYMD:e.fileCreatedYMD,ext:h}),b=new Blob([g],{type:w||"image/webp"}),A=await new Promise(((e,t)=>{const r=new FileReader;r.onload=()=>e(r.result),r.onerror=t,r.readAsDataURL(b)}));chrome.runtime.sendMessage({type:"SA_DOWNLOAD_DATAURL",dataUrl:A,filename:S},(e=>{chrome.runtime.lastError||e?.ok}))}catch(e){}finally{window.SA._seaart_running=!1}}}chrome.runtime.onMessage.addListener(((e,t,r)=>{if("SA_DO_DOWNLOAD"===e?.type){try{const{arrayBuffer:t,filename:o,mime:n}=e.payload,i=new Blob([t],{type:n||"image/webp"}),a=URL.createObjectURL(i),c=document.createElement("a");c.style.display="none",c.href=a,c.download=o||"download",document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout((()=>URL.revokeObjectURL(a)),3e4),r({ok:!0})}catch(e){r({ok:!1,error:String(e)})}return!0}})),chrome.runtime.onMessage.addListener((e=>{"SA_TRIGGER"===e?.type&&runDownload()}))}